<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartClass - Power Up 4: This Is My World</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap');

        :root {
            --navy-tech: #1A1F36;
            --electric-mint: #2CE6B8;
            --sun-coral: #F85F73;
            --blanco-nitido: #F9FAFC;
            --gris-suave: #E5E7EB;
            --gris-medio: #D1D5DB;
            --gris-oscuro: #6B7280;
            --verde-exito: #10B981; 
            --verde-exito-oscuro: #059669; 
            --rojo-error: #EF4444;
            --amarillo-info: #F59E0B;
            --azul-claro-fondo: #EFF6FF;
            --texto-principal: #1F2937;
            --texto-secundario: #4B5563;
            
            --font-principal-fallback: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-principal: 'Outfit', var(--font-principal-fallback);
            --font-titulos: 'Montserrat', var(--font-principal-fallback);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --sidebar-width-desktop: 300px;
            --header-height: 70px; 
        }

        /* Animaciones (sin cambios) */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseFeedback { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        @keyframes tada { 0% {transform: scale(1);} 10%, 20% {transform: scale(0.9) rotate(-3deg);} 30%, 50%, 70%, 90% {transform: scale(1.1) rotate(3deg);} 40%, 60%, 80% {transform: scale(1.1) rotate(-3deg);} 100% {transform: scale(1) rotate(0);} }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(248, 95, 115, 0.6); } 70% { box-shadow: 0 0 0 12px rgba(248, 95, 115, 0); } 100% { box-shadow: 0 0 0 0 rgba(248, 95, 115, 0); } }
        @keyframes modal-pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-principal);
            margin: 0;
            background-color: var(--blanco-nitido);
            color: var(--texto-principal);
            line-height: 1.7;
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-top: var(--header-height);
        }

        header {
            background-color: var(--navy-tech);
            color: var(--blanco-nitido);
            padding: 0 25px;
            display: flex;
            align-items: center;
            justify-content: space-between; 
            height: var(--header-height);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1002;
            box-shadow: var(--shadow-md);
        }
        .logo { font-family: var(--font-titulos); font-size: 1.8em; font-weight: 700; letter-spacing: 0.5px; }
        .mobile-menu-toggle { display: none; font-size: 1.8em; color: var(--blanco-nitido); background: none; border: none; cursor: pointer; padding: 10px; }
        .main-wrapper { display: flex; flex-grow: 1; }

        .sidebar {
            width: var(--sidebar-width-desktop);
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--gris-suave);
            flex-shrink: 0;
            position: sticky; 
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
        }
        .sidebar-header-info { padding: 20px; border-bottom: 1px solid var(--gris-suave); flex-shrink: 0; }
        .sidebar-header-info h1.lesson-title-sidebar { font-family: var(--font-titulos); font-size: 1.3em; color: var(--navy-tech); margin: 0 0 10px 0; font-weight: 600; line-height: 1.3; }
        .progress-bar-wrapper { display: flex; align-items: center; gap: 10px; }
        .progress-bar-container-sidebar { flex-grow: 1; background-color: var(--gris-medio); border-radius: 15px; margin-bottom: 0; height: 20px; position: relative; overflow: hidden; }
        .progress-bar-sidebar { width: 0%; height: 100%; background-color: var(--verde-exito); border-radius: 15px; transition: width 0.7s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .progress-percentage-text { font-size: 0.9em; font-weight: 600; color: var(--verde-exito-oscuro); min-width: 40px; text-align: right; }
        .sidebar-menu-container { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .sidebar-menu-container h3.sidebar-group-title { font-family: var(--font-titulos); color: var(--gris-oscuro); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--gris-medio); display: flex; align-items: center; }
        .sidebar-menu-container h3.sidebar-group-title:first-child { margin-top: 0; }
        .sidebar-menu-container h3.sidebar-group-title .icon { font-size: 1.1em; color: var(--navy-tech); margin-right: 8px; }
        #lessonSectionsMenu ul { list-style: none; padding: 0; margin: 0; }
        #lessonSectionsMenu li a { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; text-decoration: none; color: var(--texto-secundario); border-radius: 6px; margin-bottom: 4px; transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease; font-weight: 500; font-size: 0.9em; }
        #lessonSectionsMenu li a .menu-item-text { display: flex; align-items: center; flex-grow: 1; }
        #lessonSectionsMenu li a .menu-icon { margin-right: 10px; font-size: 1.1em; color: var(--gris-oscuro); width: 20px; text-align: center; transition: color 0.2s ease; }
        #lessonSectionsMenu li a .completed-check { font-size: 1.1em; color: var(--verde-exito-oscuro); margin-left: 8px; font-weight: bold; opacity: 0; transition: opacity 0.3s ease; }
        #lessonSectionsMenu li a.step-completed .completed-check { opacity: 1; }
        #lessonSectionsMenu li a:hover { background-color: var(--gris-suave); color: var(--navy-tech); }
        #lessonSectionsMenu li a:hover .menu-icon { color: var(--navy-tech); }
        #lessonSectionsMenu li a.active { background-color: var(--electric-mint); color: var(--navy-tech) !important; font-weight: 600; box-shadow: var(--shadow-sm); }
        #lessonSectionsMenu li a.active .menu-icon { color: var(--navy-tech); }
        #lessonSectionsMenu li a.active.step-completed .completed-check { color: var(--navy-tech); }

        .content-area { flex-grow: 1; padding: 30px; }
        .lesson-step { background-color: #fff; padding: 25px; margin-bottom: 35px; border-radius: 12px; border: 1px solid var(--gris-suave); box-shadow: var(--shadow-md); animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        h2 { font-family: var(--font-titulos); margin-top: 0; margin-bottom: 25px; padding-bottom: 10px; font-size: 1.8em; color: var(--navy-tech); display: flex; align-items: center; font-weight: 600; cursor: pointer; transition: color 0.2s; }
        h2:hover { color: var(--electric-mint); }
        h2.situation-title { border-bottom: 3px solid #60A5FA; }
        h2.grammar-pill-title { border-bottom: 3px solid #A78BFA; }
        h2.speech-lab-title { border-bottom: 3px solid var(--sun-coral); }
        h2.ai-chat-title { border-bottom: 3px solid #F472B6; } 
        h2.snacks-title { border-bottom: 3px solid var(--verde-exito); }
        h2.tips-title { border-bottom: 3px solid var(--amarillo-info); }
        .lesson-step p { color: var(--texto-secundario); font-size: 1.05em; margin-bottom: 15px; font-weight: 400; }
        
        .speakable { cursor: pointer; transition: color 0.2s, background-color 0.2s; border-radius: 3px; }
        .speakable:hover { background-color: var(--azul-claro-fondo); color: var(--sun-coral); }

        .situation-box { border: 1px solid var(--gris-medio); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm); }
        .situation-video-placeholder { background-color: var(--navy-tech); color: white; padding: 40px 20px; text-align: center; }
        .situation-video-placeholder .icon { font-size: 3em; margin-bottom: 15px; }
        .situation-video-placeholder p { font-size: 1.2em; color: var(--blanco-nitido); margin: 0; font-weight: 500; }
        .situation-transcript { background-color: var(--azul-claro-fondo); padding: 20px; font-size: 1.1em; color: var(--texto-principal); }
        .situation-transcript .speaker { font-weight: 700; color: var(--sun-coral); }
        .situation-question { padding: 20px; background-color: #f8f9fa; }

        .grammar-pill-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .grammar-pill-card { background-color: var(--azul-claro-fondo); border-left: 5px solid #A78BFA; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; align-items: flex-start; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .grammar-pill-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .grammar-pill-card .content { flex-grow: 1; width: 100%; }
        .grammar-pill-card .title { font-size: 1.3em; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .grammar-pill-card .title .term { color: var(--navy-tech); }
        .grammar-pill-card .example { font-style: italic; color: var(--texto-secundario); font-size: 0.9em; margin-top: 5px; background-color: #fff; padding: 8px; border-radius: 4px; border-left: 3px solid var(--electric-mint); }
        
        button, .button-like { font-family: var(--font-principal); background-color: var(--electric-mint); color: var(--navy-tech); border: none; padding: 12px 22px; border-radius: 25px; cursor: pointer; font-size: 1.05em; font-weight: 600; transition: all 0.2s ease-out; margin-top: 10px; display: inline-flex; align-items: center; box-shadow: var(--shadow-sm); text-decoration: none; }
        button:hover, .button-like:hover { background-color: #23bba0; transform: translateY(-2px) scale(1.02); box-shadow: var(--shadow-md); }
        button.record-btn { background-color: var(--sun-coral); color: var(--blanco-nitido); }
        button.record-btn:hover { background-color: #e04f62; }
        button.record-btn.recording { background-color: #c0392b; animation: pulse 1.2s infinite ease-in-out; }
        button.mark-completed-btn { background-color: var(--gris-suave); color: var(--texto-secundario); font-size: 0.95em; padding: 10px 18px; font-weight: 500; }
        button.mark-completed-btn.completed { background-color: var(--verde-exito); color: white; cursor: default; font-weight: 600; }
        .icon { font-size: 1.4em; margin-right: 10px; vertical-align: middle; }
        h2 .icon { font-size: 1.2em; margin-right: 15px; padding: 8px; border-radius: 8px; color: white; }
        h2.situation-title .icon { background-color: #60A5FA; }
        h2.grammar-pill-title .icon { background-color: #A78BFA; }
        h2.speech-lab-title .icon { background-color: var(--sun-coral); }
        h2.ai-chat-title .icon { background-color: #F472B6; } 
        h2.snacks-title .icon { background-color: var(--verde-exito); }
        h2.tips-title .icon { background-color: var(--amarillo-info); }
        
        .feedback { padding: 15px 20px; margin-top: 12px; border-radius: 10px; font-weight: 500; font-size: 1.1em; text-align: center; animation: pulseFeedback 0.5s ease; border-width: 2px; border-style: solid; }
        .feedback.success { background-color: #ECFDF5; color: #065F46; border-color: var(--verde-exito); }
        .feedback.error { background-color: #FEF2F2; color: #991B1B; border-color: var(--rojo-error); }
        .feedback.info { background-color: #EFF6FF; color: #1E40AF; border-color: #60A5FA; }

        .phrase-block { background-color: var(--blanco-nitido); border: 1px solid var(--gris-medio); padding: 18px 22px; margin-bottom: 15px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
        .phrase-text { font-size: 1.35em; color: var(--texto-principal); font-weight: 500; }

        .quiz-question { margin-top: 20px; }
        .quiz-question p.question-text { font-weight: 600; margin-bottom: 15px; font-size: 1.15em; color: var(--navy-tech); }
        .quiz-options label { display: block; margin-bottom: 10px; padding: 14px 18px; border: 2px solid var(--gris-medio); border-radius: 25px; cursor: pointer; transition: all 0.2s ease-out; }
        .quiz-options label:hover { background-color: #E0F2FE; border-color: var(--electric-mint); }
        .quiz-options input[type="radio"] { display:none; }
        .quiz-options label.selected { border-color: var(--electric-mint); background-color: #F0FEF9; }
        .quiz-options label.correct { background-color: #D1FAE5 !important; border-color: var(--verde-exito) !important; color: #047857; font-weight: 600; }
        .quiz-options label.incorrect { background-color: #FEE2E2 !important; border-color: var(--rojo-error) !important; color: #B91C1C; }
        
        .fill-in-the-blank-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; font-size: 1.15em; color: var(--navy-tech); }
        .fill-in-the-blank-container input { width: 80px; font-size: 1em; text-align: center; border: 2px solid var(--gris-medio); padding: 10px; border-radius: 8px; }

        /* Vocabulario Enriquecido */
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .vocab-card { background-color: #fff; border: 1px solid var(--gris-suave); border-left: 5px solid var(--electric-mint); padding: 15px; border-radius: 8px; text-align: center; box-shadow: var(--shadow-sm); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;}
        .vocab-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .vocab-card h3 { font-family: var(--font-titulos); font-size: 1.4em; color: var(--navy-tech); margin: 0 0 5px 0; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .vocab-card .phonetic { font-size: 0.9em; color: var(--sun-coral); font-weight: 500; margin: 0 0 8px 0; }
        .vocab-card .translation { font-size: 1em; color: var(--texto-secundario); font-weight: 600; margin: 0; }
        
        /* Living English Power Up Card */
        .living-english-powerup { background-color: var(--navy-tech); color: var(--blanco-nitido); border: 2px dashed var(--electric-mint); padding: 20px; margin-top: 25px; border-radius: 12px; box-shadow: var(--shadow-lg); }
        .living-english-powerup strong { color: var(--electric-mint); font-weight: 700; display: flex; align-items: center; margin-bottom: 8px; font-size: 1.2em; font-family: var(--font-titulos); }
        .living-english-powerup .icon { color: var(--electric-mint); font-size: 1.2em; margin-right: 10px; }
        .living-english-powerup p { color: var(--gris-suave); font-size: 1em; line-height: 1.6; margin: 0; }

        /* AI Interaction & Tips */
        .ai-interaction { border: 2px dashed #F472B6; background-color: #FFF5F7; }
        .ai-interaction textarea { width: 100%; box-sizing: border-box; min-height: 120px; padding: 15px; margin-top: 10px; margin-bottom: 15px; border: 2px solid var(--gris-medio); border-radius: 8px; font-family: var(--font-principal); font-size: 1.1em; resize: vertical; transition: all 0.3s ease; }
        .ai-interaction textarea:focus { outline: none; border-color: #F472B6; box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.3); }
        .ai-interaction button { background-color: #F472B6; color: white; }
        .ai-interaction button:hover { background-color: #EC4899; }
        .ai-interaction button.send-text-btn { background-color: var(--gris-suave); color: var(--texto-secundario); font-size: 0.9em; padding: 10px 18px; }
        .ai-interaction button.send-text-btn:hover { background-color: var(--gris-medio); }
        .ai-interaction button.recording { animation: pulse 1.2s infinite ease-in-out; }
        #aiResponse { margin-top: 15px; padding: 15px; background-color: var(--blanco-nitido); border: 1px solid var(--gris-suave); border-radius: 8px; min-height: 60px; white-space: pre-wrap; }
        .living-english-tip { background-color: #fff9eb; border: 1px solid #ffe7ba; border-left: 5px solid var(--amarillo-info); padding: 15px 20px; margin: 15px 0; border-radius: 8px; font-size: 1em; line-height: 1.6; box-shadow: var(--shadow-sm); }
        .living-english-tip strong { color: #b45309; font-weight: 600; display: flex; align-items: center; margin-bottom: 5px; }
        .living-english-tip .icon { color: var(--amarillo-info); font-size: 1.2em; margin-right: 8px; }

        #completionOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 31, 54, 0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #completionModal { background: white; padding: 40px; border-radius: 16px; text-align: center; box-shadow: var(--shadow-lg); animation: modal-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; max-width: 500px; width: 90%; }
        #completionModal .icon { font-size: 4em; display: inline-block; animation: tada 1s; }
        #completionModal h2 { font-size: 2em; color: var(--navy-tech); border: none; margin-bottom: 10px; justify-content: center; }
        #completionModal p { font-size: 1.2em; color: var(--texto-secundario); margin-bottom: 25px; }

        @media (max-width: 850px) {
            body { padding-top: 0; }
            header { position: static; height: auto; padding: 15px; flex-direction: column; }
            .mobile-menu-toggle { display: flex; align-self: flex-start; }
            .logo { margin-top: -35px; }
            .main-wrapper { flex-direction: column; }
            .sidebar { width: 85%; max-width: 280px; position: fixed; top: 0; left: -100%; bottom: 0; z-index: 1001; transition: left 0.3s ease-in-out; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
            .sidebar.active { left: 0; }
            .content-area { padding: 20px 15px; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
            .sidebar.active ~ .overlay { display: block; }
            h2 { font-size: 1.6em; }
        }
    </style>
</head>
<body>
    <header id="appHeader">
        <button class="mobile-menu-toggle" aria-label="Toggle menu" onclick="toggleMobileMenu()">‚ò∞</button>
        <div class="logo">SMARTCLASS</div>
        <div style="width: 48px;" class="header-placeholder"></div> 
    </header>

    <div class="main-wrapper">
        <aside class="sidebar" id="lessonSidebar">
            <div class="sidebar-header-info">
                <h1 class="lesson-title-sidebar">Power Up 4: This Is My World</h1>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-container-sidebar">
                        <div class="progress-bar-sidebar" id="progressBarSidebar"></div>
                    </div>
                    <span class="progress-percentage-text" id="progressTextSidebar">0%</span>
                </div>
            </div>
            <div class="sidebar-menu-container">
                <nav id="lessonSectionsMenu"></nav>
            </div>
        </aside>
        <div class="overlay" id="mobileMenuOverlay" onclick="toggleMobileMenu()"></div>

        <main class="content-area" id="contentArea">
            <p style="font-size: 1.2em; text-align: center; color: var(--texto-secundario); margin-bottom: 30px; font-weight: 500;">
                ¬°Bienvenido al Power Up 4! ‚ö°Ô∏è Hoy vas a dominar el arte de describir tu mundo, desde las cosas que puedes tocar hasta las profesiones de la gente que admiras. ¬°Empecemos!
            </p>

            <!-- TEMA 1: POINTING AT THINGS -->
            <section id="section-situationPointing" class="lesson-step" data-step-id="situationPointing" data-group-title="Pointing at Things üëÜ" data-group-icon="üëÜ" data-title="Situation: Organizing the Desk" data-icon="üü¶">
                <h2 class="situation-title"><span class="icon">üü¶</span>Situation: Organizing the Desk</h2>
                <p>Imagina que est√°s ayudando a un amigo a organizar su escritorio. Encuentran cosas cerca y ven otras lejos. ¬°Escucha c√≥mo hablan de ellas!</p>
                <div class="situation-box">
                    <div class="situation-video-placeholder"><div class="icon">üì¶</div><p class="speakable" onclick="speakPhrase('What is this? What are those?', 'en-US')">What is this? What are those?</p></div>
                    <div class="situation-transcript">
                        <p><span class="speaker">Ana:</span> <span class="speakable" onclick="speakPhrase(this.textContent, 'en-US')">Wow, your desk is messy! What is this?</span></p>
                        <p><span class="speaker">Leo:</span> <span class="speakable" onclick="speakPhrase(this.textContent, 'en-US')">Oh, that is my old notebook. And these are my favorite pencils.</span></p>
                        <p><span class="speaker">Ana:</span> <span class="speakable" onclick="speakPhrase(this.textContent, 'en-US')">I see. And what are those books on the shelf over there?</span></p>
                        <p><span class="speaker">Leo:</span> <span class="speakable" onclick="speakPhrase(this.textContent, 'en-US')">Those are my graphic novels. They are really good!</span></p>
                    </div>
                </div>
                <div class="living-english-powerup">
                    <strong class="speakable" onclick="speakPhrase(this.textContent, 'en-US')"><span class="icon">üöÄ</span>Living English Power-Up:</strong>
                    <p>La pr√≥xima vez que hables con alguien, intenta se√±alar algo y decir <strong class="speakable" onclick="speakPhrase('this is...', 'en-US')" style="color: var(--electric-mint);">"This is..."</strong> o <strong class="speakable" onclick="speakPhrase('that is...', 'en-US')" style="color: var(--electric-mint);">"That is..."</strong>. Es una forma s√∫per natural de iniciar o continuar una conversaci√≥n.</p>
                </div>
                <button class="mark-completed-btn" onclick="markStepCompleted('situationPointing', this)"><span class="icon">‚úîÔ∏è</span> Entend√≠ la situaci√≥n</button>
            </section>

            <section id="section-grammarPillDemonstratives" class="lesson-step" data-step-id="grammarPillDemonstratives" data-group-title="Pointing at Things üëÜ" data-group-icon="üëÜ" data-title="Grammar Pill: El Dedo M√°gico" data-icon="üü™">
                <h2 class="grammar-pill-title"><span class="icon">üü™</span>Grammar Pill: The Magic Finger</h2>
                <p>Piensa en estas 4 palabras como si fueran tu dedo. Lo que puedes tocar vs. lo que tienes que se√±alar.</p>
                <div class="grammar-pill-grid">
                    <div class="grammar-pill-card" onclick="speakPhrase('This. One thing, near me. This is my phone.', 'en-US')">
                        <div class="content"><div class="title"><span class="term">This</span><span>(1 cosa, cerca)</span></div><div class="example"><strong>This</strong> is my phone.</div></div>
                    </div>
                     <div class="grammar-pill-card" onclick="speakPhrase('That. One thing, far from me. That is the clock.', 'en-US')">
                        <div class="content"><div class="title"><span class="term">That</span><span>(1 cosa, lejos)</span></div><div class="example"><strong>That</strong> is the clock.</div></div>
                    </div>
                     <div class="grammar-pill-card" onclick="speakPhrase('These. Two or more things, near me. These are my keys.', 'en-US')">
                        <div class="content"><div class="title"><span class="term">These</span><span>(2+ cosas, cerca)</span></div><div class="example"><strong>These</strong> are my keys.</div></div>
                    </div>
                     <div class="grammar-pill-card" onclick="speakPhrase('Those. Two or more things, far from me. Those are your books.', 'en-US')">
                        <div class="content"><div class="title"><span class="term">Those</span><span>(2+ cosas, lejos)</span></div><div class="example"><strong>Those</strong> are your books.</div></div>
                    </div>
                </div>
                <button class="mark-completed-btn" onclick="markStepCompleted('grammarPillDemonstratives', this)"><span class="icon">‚úîÔ∏è</span> Entend√≠ la gram√°tica</button>
            </section>
            
            <section id="section-speechLabPointing" class="lesson-step" data-step-id="speechLabPointing" data-group-title="Pointing at Things üëÜ" data-group-icon="üëÜ" data-title="Speech Lab: ¬°Se√±ala y Habla!" data-icon="üü•">
                <h2 class="speech-lab-title"><span class="icon">üü•</span>Speech Lab: Point and Speak!</h2>
                <p>Imagina que est√°s en tu habitaci√≥n. Gr√°bate diciendo estas frases. ¬°Imita la pronunciaci√≥n!</p>
                <div class="phrase-block"><p class="phrase-text speakable" onclick="speakPhrase(this.textContent, 'en-US')">This is my desk.</p><button class="record-btn" onclick="startRecognition('recordFeedbackP1', this)"><span class="icon">üé§</span> Grabar</button></div>
                <div id="recordFeedbackP1" class="feedback" style="display:none;"></div>
                <div class="phrase-block"><p class="phrase-text speakable" onclick="speakPhrase(this.textContent, 'en-US')">Those are my shoes.</p><button class="record-btn" onclick="startRecognition('recordFeedbackP2', this)"><span class="icon">üé§</span> Grabar</button></div>
                <div id="recordFeedbackP2" class="feedback" style="display:none;"></div>
                <button class="mark-completed-btn" onclick="markStepCompleted('speechLabPointing', this)"><span class="icon">‚úîÔ∏è</span> Practiqu√© la pronunciaci√≥n</button>
            </section>

            <section id="section-snacksNumbers" class="lesson-step" data-step-id="snacksNumbers" data-group-title="Pointing at Things üëÜ" data-group-icon="üëÜ" data-title="Snacks: Los Grandes N√∫meros üî¢" data-icon="üü©">
                <h2 class="snacks-title"><span class="icon">üü©</span>Snacks: Big Numbers & Order</h2>
                <p>Para contar todo lo que ves, necesitas n√∫meros m√°s grandes. ¬°Vamos a aprenderlos!</p>
                <div class="vocab-grid" id="numbers-grid">
                    <!-- Generado por JS -->
                </div>
                <button class="mark-completed-btn" onclick="markStepCompleted('snacksNumbers', this)"><span class="icon">‚úîÔ∏è</span> Repas√© los n√∫meros</button>
            </section>

            <!-- TEMA 2: WHAT DO YOU DO? -->
            <section id="section-situationJobs" class="lesson-step" data-step-id="situationJobs" data-group-title="What Do You Do? üë∑" data-group-icon="üë∑" data-title="Situation: Career Day" data-icon="üü¶">
                <h2 class="situation-title"><span class="icon">üü¶</span>Situation: Career Day</h2>
                <p>Es el d√≠a de las profesiones en la escuela. Dos amigos hablan sobre lo que quieren ser en el futuro.</p>
                <div class="situation-box">
                    <div class="situation-video-placeholder"><div class="icon">üë©‚Äç‚öïÔ∏èüë®‚ÄçüöÄ</div><p class="speakable" onclick="speakPhrase('What do you want to be?', 'en-US')">What do you want to be?</p></div>
                    <div class="situation-transcript">
                        <p><span class="speaker">Carlos:</span> <span class="speakable" onclick="speakPhrase(this.textContent, 'en-US')">My mom is a doctor. She works at a big hospital.</span></p>
                        <p><span class="speaker">Sofia:</span> <span class="speakable" onclick="speakPhrase(this.textContent, 'en-US')">Wow, that's cool! I want to be an engineer. It is an interesting job.</span></p>
                    </div>
                </div>
                <div class="living-english-powerup">
                    <strong class="speakable" onclick="speakPhrase(this.textContent, 'en-US')"><span class="icon">üöÄ</span>Living English Power-Up:</strong>
                    <p>En espa√±ol decimos "Soy doctor", pero en ingl√©s es fundamental usar el art√≠culo: <strong class="speakable" onclick="speakPhrase('I am A doctor', 'en-US')" style="color: var(--electric-mint);">"I am A doctor"</strong>. Olvidar "a" o "an" es un error muy com√∫n. ¬°Gr√°batelo en la mente!</p>
                </div>
                <button class="mark-completed-btn" onclick="markStepCompleted('situationJobs', this)"><span class="icon">‚úîÔ∏è</span> Entend√≠ la situaci√≥n</button>
            </section>

             <section id="section-grammarPillArticles" class="lesson-step" data-step-id="grammarPillArticles" data-group-title="What Do You Do? üë∑" data-group-icon="üë∑" data-title="Grammar Pill: Un vs. El" data-icon="üü™">
                <h2 class="grammar-pill-title"><span class="icon">üü™</span>Grammar Pill: A, An, The</h2>
                <p>Estas tres palabritas lo cambian todo. Indican si hablas de algo general (un/una) o algo espec√≠fico (el/la).</p>
                <div class="grammar-pill-grid">
                    <div class="grammar-pill-card" onclick="speakPhrase('A. Before a consonant sound. A doctor. A university.', 'en-US')">
                        <div class="content"><div class="title"><span class="term">A</span><span>(sonido de consonante)</span></div><div class="example"><strong>a</strong> doctor, <strong>a</strong> university</div></div>
                    </div>
                     <div class="grammar-pill-card" onclick="speakPhrase('An. Before a vowel sound. An engineer. An hour.', 'en-US')">
                        <div class="content"><div class="title"><span class="term">An</span><span>(sonido de vocal)</span></div><div class="example"><strong>an</strong> engineer, <strong>an</strong> hour</div></div>
                    </div>
                     <div class="grammar-pill-card" onclick="speakPhrase('The. For a specific thing. The doctor from the hospital. The engineer from my company.', 'en-US')">
                        <div class="content"><div class="title"><span class="term">The</span><span>(algo espec√≠fico)</span></div><div class="example"><strong>the</strong> doctor from the hospital</div></div>
                    </div>
                </div>
                <button class="mark-completed-btn" onclick="markStepCompleted('grammarPillArticles', this)"><span class="icon">‚úîÔ∏è</span> Entend√≠ los art√≠culos</button>
            </section>

             <section id="section-speechLabJobs" class="lesson-step" data-step-id="speechLabJobs" data-group-title="What Do You Do? üë∑" data-group-icon="üë∑" data-title="Speech Lab: Tu Futuro" data-icon="üü•">
                <h2 class="speech-lab-title"><span class="icon">üü•</span>Speech Lab: Your Future</h2>
                <p>Ahora te toca so√±ar. ¬øQu√© te gustar√≠a ser? Gr√°bate diciendo estas frases. ¬°Atenci√≥n a "a" y "an"!</p>
                <div class="phrase-block"><p class="phrase-text speakable" onclick="speakPhrase(this.textContent, 'en-US')">I want to be a baker.</p><button class="record-btn" onclick="startRecognition('recordFeedbackJ1', this)"><span class="icon">üé§</span> Grabar</button></div>
                <div id="recordFeedbackJ1" class="feedback" style="display:none;"></div>
                <div class="phrase-block"><p class="phrase-text speakable" onclick="speakPhrase(this.textContent, 'en-US')">My father is an accountant.</p><button class="record-btn" onclick="startRecognition('recordFeedbackJ2', this)"><span class="icon">üé§</span> Grabar</button></div>
                <div id="recordFeedbackJ2" class="feedback" style="display:none;"></div>
                <button class="mark-completed-btn" onclick="markStepCompleted('speechLabJobs', this)"><span class="icon">‚úîÔ∏è</span> Practiqu√© mi futuro</button>
            </section>
            
            <section id="section-snacksJobs" class="lesson-step" data-step-id="snacksJobs" data-group-title="What Do You Do? üë∑" data-group-icon="üë∑" data-title="Snacks: El mundo del trabajo üíº" data-icon="üü©">
                <h2 class="snacks-title"><span class="icon">üü©</span>Snacks: The World of Work</h2>
                <p>Aqu√≠ tienes algunas de las profesiones m√°s comunes. ¬°Aprende c√≥mo se llaman!</p>
                <div class="vocab-grid" id="occupations-grid">
                    <!-- Generado por JS -->
                </div>
                <button class="mark-completed-btn" onclick="markStepCompleted('snacksJobs', this)"><span class="icon">‚úîÔ∏è</span> Aprend√≠ las profesiones</button>
            </section>

            <section id="section-aiChat" class="lesson-step ai-interaction" data-step-id="aiChat" data-group-title="Bonus üåü" data-group-icon="üåü" data-title="Charla con Sparky" data-icon="ü§ñ">
                <h2 class="ai-chat-title"><span class="icon">ü§ñ</span>Charla con Sparky</h2>
                <p>¬°Es hora de practicar todo! Describe tu cuarto a Sparky y dile que quieres ser de grande</p>
                <textarea id="aiUserInput" placeholder="Escribe aqu√≠ en ingl√©s... Ej: Hi Sparky. This is my room. There is a big bed and there are two windows. I want to be an architect."></textarea>
                <div class="ai-buttons-container">
                    <button id="sparky-voice-btn" onclick="startSparkyVoiceInteraction()"><span class="icon">üé§</span> Hablar con Sparky</button>
                    <button onclick="askGemini()" class="send-text-btn"><span class="icon">‚úâÔ∏è</span> Enviar Texto</button>
                </div>
                <div id="aiResponse" class="speakable" onclick="speakPhrase(this.textContent.replace('Sparky dice: ', ''), 'en-US')">Sparky est√° listo para charlar...</div>
                <button class="mark-completed-btn" onclick="markStepCompleted('aiChat', this)"><span class="icon">‚úîÔ∏è</span> Charl√© con Sparky</button>
            </section>

            <section id="section-tips" class="lesson-step" data-step-id="tips" data-group-title="Bonus üåü" data-group-icon="üåü" data-title="Tips & Tricks" data-icon="üåü">
                <h2 class="tips-title"><span class="icon">üåü</span>Tips & Tricks</h2>
                <p>¬°Has llegado a la secci√≥n de secretos! Aqu√≠ tienes los mejores consejos para dominar las descripciones y sonar como un pro.</p>
                <div class="living-english-tip">
                    <strong class="speakable" onclick="speakPhrase(this.textContent, 'en-US')"><span class="icon">üéØ</span>El truco del "Dedo que Apunta"</span>
                    <p>No pienses en "singular" o "plural". Piensa: ¬ølo puedo tocar? Usa <strong style="color: #b45309;">This/These</strong>. ¬øLo tengo que se√±alar porque est√° lejos? Usa <strong style="color: #b45309;">That/Those</strong>. Esta regla f√≠sica es mucho m√°s f√°cil de recordar que la gram√°tica abstracta.</p>
                </div>
                <div class="living-english-tip">
                    <strong class="speakable" onclick="speakPhrase(this.textContent, 'en-US')"><span class="icon">üéß</span>El truco del Sonido para A/AN</span>
                    <p>Olvida si la palabra empieza con vocal o consonante. Escucha el **sonido**. "University" empieza con sonido /juu/ (como 'you'), que es un sonido de consonante. Por eso es "**a** university". "Hour" empieza con sonido /au/, que es un sonido de vocal. Por eso es "**an** hour". ¬°Conf√≠a en tu o√≠do!</p>
                </div>
                 <div class="living-english-tip">
                    <strong class="speakable" onclick="speakPhrase(this.textContent, 'en-US')"><span class="icon">‚úçÔ∏è</span>El Desaf√≠o de "Etiquetar tu Mundo"</span>
                    <p>Toma 5 notas adhesivas. Escribe "This is a/an..." en cada una. P√©galas en 5 objetos a tu alrededor. "This is a lamp." "This is a computer." "This is an eraser." Dejarlas ah√≠ por un d√≠a grabar√° el vocabulario y la estructura en tu cerebro sin esfuerzo.</p>
                </div>
                 <button class="mark-completed-btn" onclick="markStepCompleted('tips', this)"><span class="icon">‚úîÔ∏è</span> Entend√≠ los tips</button>
            </section>
            
            <div style="text-align: center; margin-top: 40px;">
                <button id="finishLessonBtn" onclick="showCompletionModal()" style="padding: 15px 35px; font-size: 1.2em; background-color: var(--navy-tech); color: var(--blanco-nitido);"><span class="icon">üèÅ</span> Finalizar Power Up</button>
            </div>
        </main>
    </div>

    <div id="completionOverlay">
        <div id="completionModal">
            <div class="icon">üéâ</div>
            <h2>¬°Power Up Completado!</h2>
            <p>¬°Felicidades! Has dominado c√≥mo describir tu mundo. Est√°s 100% listo para brillar en tu pr√≥xima clase en vivo.</p>
            <button onclick="hideCompletionModal()">Cerrar</button>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = "AIzaSyBHu1xRa0X4WXZNprZSnUpsSCc9d5Jbzqs"; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
        
        // <!-- EDITABLE: Lista de IDs de los pasos para la barra de progreso -->
        const trackableStepIds = [
            'situationPointing', 'grammarPillDemonstratives', 'speechLabPointing', 'snacksNumbers', 
            'situationJobs', 'grammarPillArticles', 'speechLabJobs', 'snacksJobs',
            'aiChat', 'tips'
        ];
        
        let progress = 0;
        let totalInteractiveSteps = trackableStepIds.length;
        let completedSteps = new Set();
        let progressBarSidebarEl, progressTextSidebarEl, contentAreaEl, sidebarMenuEl, appHeaderEl, lessonSidebarGlobalEl, overlayEl, completionOverlayEl;
        let lessonSections = []; 
        let headerActualHeight = 70; 
        let voices = []; 
        let preferredVoices = {};
        const synth = window.speechSynthesis;
        let recognition;
        let isMobileMenuOpen = false;
        let intersectionObserver;

        function initializeSpeechAPI() {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
            } else {
                console.warn("Speech Recognition API no es compatible.");
                document.querySelectorAll('.record-btn, #sparky-voice-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="icon">üö´</span> No Soportado';
                });
            }
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = getAndSetVoices;
            }
        }
        
        function getAndSetVoices() {
            voices = synth.getVoices();
             if (voices.length > 0) {
                const highQualityVoiceNames = /Google US English|Samantha|Alex|Zira|David|Susan|Daniel/i;
                preferredVoices['en-US'] =
                    voices.find(v => v.lang === 'en-US' && highQualityVoiceNames.test(v.name)) ||
                    voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) ||
                    voices.find(v => v.lang === 'en-US' && v.localService) ||
                    voices.find(v => v.lang === 'en-US') ||
                    voices.find(v => v.lang.startsWith('en-'));
                
                if (typeof synth.onvoiceschanged === "function") {
                    synth.onvoiceschanged = null; 
                }
            }
        }
        
        function playSound(type) {
             try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (!audioCtx) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                let duration = 0.2;
                if (type === 'correct') {
                    oscillator.type = 'sine'; 
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime); 
                    oscillator.frequency.linearRampToValueAtTime(1046.50, audioCtx.currentTime + 0.1); 
                } else if (type === 'incorrect') {
                    oscillator.type = 'square'; 
                    oscillator.frequency.setValueAtTime(164.81, audioCtx.currentTime);
                    duration = 0.25;
                } else if (type === 'tada') {
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
                    oscillator.frequency.linearRampToValueAtTime(1046.50, audioCtx.currentTime + 0.3);
                    duration = 0.4;
                }
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration);
            } catch (e) { console.warn("No se pudo reproducir el sonido de feedback:", e); }
        }

        function updateProgressBar() {
            progress = (totalInteractiveSteps > 0) ? (completedSteps.size / totalInteractiveSteps) * 100 : 0;
            if(progressBarSidebarEl) progressBarSidebarEl.style.width = progress + '%';
            if(progressTextSidebarEl) progressTextSidebarEl.textContent = Math.round(progress) + '%';
        }
        
        function markStepCompleted(stepTrackId, buttonElement) { 
            if (completedSteps.has(stepTrackId)) return;
            completedSteps.add(stepTrackId);
            
            if(buttonElement) { 
                buttonElement.classList.add('completed');
                buttonElement.innerHTML = `<span class="icon">‚úîÔ∏è</span> ¬°Logrado!`;
                buttonElement.disabled = true;
            }
            
            const menuItemLink = document.querySelector(`#lessonSectionsMenu a[href="#section-${stepTrackId}"]`);
            if (menuItemLink) {
                 menuItemLink.classList.add('step-completed');
                 if (!menuItemLink.querySelector('.completed-check')) {
                    const checkSpan = document.createElement('span');
                    checkSpan.classList.add('completed-check');
                    checkSpan.textContent = '‚úîÔ∏è';
                    menuItemLink.appendChild(checkSpan);
                 }
            }
            updateProgressBar();
        }

        function populateSidebar() {
            if (!sidebarMenuEl || !contentAreaEl) return;
            sidebarMenuEl.innerHTML = '';
            lessonSections = Array.from(contentAreaEl.querySelectorAll('section.lesson-step[data-group-title]'));
            
            const groups = {};
            lessonSections.forEach(section => {
                const groupTitle = section.dataset.groupTitle;
                if (!groups[groupTitle]) {
                    groups[groupTitle] = { icon: section.dataset.groupIcon, sections: [] };
                }
                groups[groupTitle].sections.push(section);
            });

            for (const groupTitle in groups) {
                const groupData = groups[groupTitle];
                const h3 = document.createElement('h3');
                h3.classList.add('sidebar-group-title');
                h3.innerHTML = `<span class="icon">${groupData.icon}</span> ${groupTitle}`;
                sidebarMenuEl.appendChild(h3);

                const ul = document.createElement('ul');
                groupData.sections.forEach(section => {
                    const title = section.dataset.title;
                    const icon = section.dataset.icon || 'üîπ';
                    const sectionHtmlId = section.id;
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `#${sectionHtmlId}`;
                    link.innerHTML = `<span class="menu-item-text"><span class="menu-icon">${icon}</span> ${title}</span>`;
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        scrollToSection(sectionHtmlId);
                        if (window.innerWidth <= 850 && isMobileMenuOpen) toggleMobileMenu();
                    });
                    listItem.appendChild(link);
                    ul.appendChild(listItem);
                });
                sidebarMenuEl.appendChild(ul);
            }
        }
        
        function setupIntersectionObserver() {
            if (intersectionObserver) intersectionObserver.disconnect();
            headerActualHeight = appHeaderEl ? appHeaderEl.offsetHeight : 70; 
            const options = { root: null, rootMargin: `-${headerActualHeight + 20}px 0px -60% 0px`, threshold: 0 };
            intersectionObserver = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) updateActiveMenuItemDOM(entry.target.id);
                });
            }, options);
            lessonSections.forEach(section => intersectionObserver.observe(section));
        }
        
        function updateActiveMenuItemDOM(activeSectionId) {
             if (sidebarMenuEl) {
                sidebarMenuEl.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                const linkToActivate = sidebarMenuEl.querySelector(`a[href="#${activeSectionId}"]`);
                if (linkToActivate) linkToActivate.classList.add('active');
             }
        }

        function scrollToSection(sectionHtmlId) {
            const section = document.getElementById(sectionHtmlId);
            if (section) {
                const yOffset = -(headerActualHeight + 15); 
                const y = section.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({ top: y, behavior: 'smooth' });
                updateActiveMenuItemDOM(sectionHtmlId);
            }
        }
        
        function toggleMobileMenu() {
            isMobileMenuOpen = !isMobileMenuOpen;
            lessonSidebarGlobalEl.classList.toggle('active', isMobileMenuOpen);
            overlayEl.style.display = isMobileMenuOpen ? 'block' : 'none';
        }
        
        function speakPhrase(text, lang = 'en-US') {
            if (!synth || !text) return;
            if (synth.speaking) synth.cancel();
            
            let cleanText = text.replace(/\[.*?\]/g, '...');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            if (preferredVoices[lang]) utterance.voice = preferredVoices[lang];
            
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            synth.speak(utterance);
        }
        
        function startRecognition(feedbackElementId, buttonElement) {
            if (!recognition) return;
            const feedbackElem = document.getElementById(feedbackElementId);
            const recordButton = buttonElement || event.target;
            
            feedbackElem.style.display = 'block';
            feedbackElem.className = 'feedback info';
            feedbackElem.innerHTML = `¬°Adelante, habla! Te escucho... üé§`;
            recordButton.classList.add('recording');
            recordButton.disabled = true;

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                feedbackElem.className = 'feedback success';
                feedbackElem.innerHTML = `¬°Genial! Escuch√©: "<em>${speechResult}</em>". ¬°Suena muy bien! üí™`;
                playSound('correct');
            }
            recognition.onspeechend = () => {
                recognition.stop();
                recordButton.classList.remove('recording');
                recordButton.disabled = false;
            }
            recognition.onerror = (event) => {
                feedbackElem.className = 'feedback error';
                feedbackElem.innerHTML = `¬°Ups! No te escuch√© bien (Error: ${event.error}). Int√©ntalo de nuevo.`;
                recordButton.classList.remove('recording');
                recordButton.disabled = false;
                playSound('incorrect');
            }
            recognition.start();
        }

        function startSparkyVoiceInteraction() {
            const aiResponseDiv = document.getElementById('aiResponse');
            const voiceButton = document.getElementById('sparky-voice-btn');
            const textButton = document.querySelector('#section-aiChat .send-text-btn');
            const userInputTextArea = document.getElementById('aiUserInput');

            if (!recognition) {
                aiResponseDiv.textContent = "Sparky dice: Lo siento, la grabaci√≥n de voz no est√° disponible en tu navegador.";
                return;
            }
            
            aiResponseDiv.textContent = "Sparky est√° escuchando...";
            voiceButton.classList.add('recording');
            voiceButton.disabled = true; textButton.disabled = true;
            voiceButton.innerHTML = '<span class="icon">üõë</span> Escuchando...';

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                userInputTextArea.value = speechResult; 
                aiResponseDiv.textContent = `Escuch√©: "${speechResult}". Ahora, Sparky est√° pensando...`;
                askGemini(); 
            }
            recognition.onerror = (event) => {
                let errorMessage = "Sparky dice: ¬°Ups! ";
                if (event.error == 'no-speech') errorMessage += 'No te escuch√© bien. ¬øPuedes intentarlo de nuevo?';
                else errorMessage += 'Hubo un error con el reconocimiento de voz.';
                aiResponseDiv.textContent = errorMessage;
                playSound('incorrect');
                resetSparkyButtons();
            }
            try { recognition.start(); } catch(e) { aiResponseDiv.textContent = "Sparky dice: Error al iniciar la grabaci√≥n."; resetSparkyButtons(); }
        }

        function resetSparkyButtons() {
            const voiceButton = document.getElementById('sparky-voice-btn');
            const textButton = document.querySelector('#section-aiChat .send-text-btn');
            if (voiceButton) {
                voiceButton.classList.remove('recording');
                voiceButton.disabled = false;
                voiceButton.innerHTML = '<span class="icon">üé§</span> Hablar con Sparky';
            }
            if (textButton) textButton.disabled = false;
        }

        async function askGemini() {
            const userInput = document.getElementById('aiUserInput').value;
            const aiResponseDiv = document.getElementById('aiResponse');
            const voiceButton = document.getElementById('sparky-voice-btn');
            const textButton = document.querySelector('#section-aiChat .send-text-btn');

            if (!userInput.trim()) return;
            
            voiceButton.disabled = true; textButton.disabled = true;
            aiResponseDiv.textContent = "Sparky est√° procesando tu mensaje...";
            
             const prompt = `Eres "Sparky", un profesor de IA amigable para un estudiante de ingl√©s A1. La lecci√≥n de hoy es sobre Demonstrativos (this, that, these, those), Art√≠culos (a, an, the) y Profesiones.

            El estudiante te dice: "${userInput}"

            Tu respuesta DEBE ser:
            1. En INGL√âS MUY SENCILLO (A1, frases cortas). S√© muy positivo. No uses emojis.
            2. Si el estudiante usa un demostrativo correctamente (ej. "This is my computer"): "Excellent! You used 'This is' perfectly. What is **that** on your wall?".
            3. Si usa un art√≠culo correctamente con una profesi√≥n (ej. "I want to be an engineer"): "Awesome! You used 'an engineer' correctly. That is a great job! What does an engineer do?".
            4. Si comete un error con el demostrativo (ej. "This are my books"): "Good try! That's very close! Remember, for many things near you, we say '**These** are my books'. Let's try again. What are those things on your shelf?".
            5. Si comete un error con el art√≠culo (ej. "She is a engineer"): "That's almost perfect! A small tip: because 'engineer' starts with a vowel sound, we use 'an'. '**An** engineer'. You are learning fast! What does your father do?".
            6. Si solo saluda: "Hello! It's great to talk to you. Let's practice. Point to something near you and tell me 'This is a...'".
            7. Para cualquier otra cosa, gu√≠a la conversaci√≥n al tema de la lecci√≥n: "That's interesting! Now, let's practice describing things. Look around your room. What is that on your desk?".
            8. Mant√©n las respuestas CORTAS (1-3 frases).
            9. **NADA DE ESPA√ëOL.** Solo ingl√©s.
            10. Responde directamente. No empieces con "Sparky says:".`;

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.7, maxOutputTokens: 150 } }),
                });
                const data = await response.json();
                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    let aiText = data.candidates[0].content.parts[0].text.trim();
                    aiResponseDiv.textContent = "Sparky dice: " + aiText;
                    speakPhrase(aiText, 'en-US');
                } else {
                    aiResponseDiv.textContent = "Sparky dice: Mmm, mi cerebro IA tuvo un cortocircuito. ¬øPodr√≠as intentarlo de nuevo?";
                }
            } catch (error) {
                console.error("Error al contactar Gemini API:", error);
                aiResponseDiv.textContent = "Sparky dice: ¬°Rayos! No pude conectar. Revisa tu internet.";
            } finally {
                resetSparkyButtons();
            }
        }
        
        function showCompletionModal() {
            if (completedSteps.size < totalInteractiveSteps) {
                alert('¬°√Ånimo! A√∫n te faltan algunos pasos para completar la misi√≥n. ¬°T√∫ puedes!');
                for (const stepId of trackableStepIds) {
                    if (!completedSteps.has(stepId)) {
                        scrollToSection(`section-${stepId}`);
                        break;
                    }
                }
            } else {
                completionOverlayEl.style.display = 'flex';
                playSound('tada');
                speakPhrase("Power Up Mission Completed! Congratulations!", 'en-US');
            }
        }
        
        function hideCompletionModal() {
            completionOverlayEl.style.display = 'none';
        }

        // --- INICIALIZACI√ìN DE LA P√ÅGINA ---
        document.addEventListener('DOMContentLoaded', () => {
            appHeaderEl = document.getElementById('appHeader');
            lessonSidebarGlobalEl = document.getElementById('lessonSidebar');
            overlayEl = document.getElementById('mobileMenuOverlay');
            completionOverlayEl = document.getElementById('completionOverlay');
            progressBarSidebarEl = document.getElementById('progressBarSidebar');
            progressTextSidebarEl = document.getElementById('progressTextSidebar');
            contentAreaEl = document.getElementById('contentArea');
            sidebarMenuEl = document.getElementById('lessonSectionsMenu');

            initializeSpeechAPI();
            getAndSetVoices();

            populateSidebar();
            setupIntersectionObserver();
            
            const numbersData = [
                { num: '30', word: 'thirty', pron: 'z√©r-ti' }, { num: '40', word: 'forty', pron: 'f√≥r-ti' },
                { num: '50', word: 'fifty', pron: 'f√≠f-ti' }, { num: '60', word: 'sixty', pron: 's√≠x-ti' },
                { num: '70', word: 'seventy', pron: 's√©-ven-ti' }, { num: '80', word: 'eighty', pron: '√©i-ti' },
                { num: '90', word: 'ninety', pron: 'n√°in-ti' }, { num: '100', word: 'one hundred', pron: 'u√°n j√°n-dred' },
                { num: '1st', word: 'first', pron: 'ferst' }, { num: '2nd', word: 'second', pron: 's√©-cond' },
                { num: '3rd', word: 'third', pron: 'zerd' }, { num: '4th', word: 'fourth', pron: 'forz' },
            ];
            
            const occupationsData = [
                { name: 'Doctor', pron: 'd√≥c-tor', emoji: 'üë©‚Äç‚öïÔ∏è' }, { name: 'Teacher', pron: 't√≠-cher', emoji: 'üë®‚Äçüè´' },
                { name: 'Engineer', pron: 'en-yi-n√≠r', emoji: 'üë∑' }, { name: 'Baker', pron: 'b√©i-ker', emoji: 'üë®‚Äçüç≥' },
                { name: 'Police Officer', pron: 'po-l√≠s √≥-fi-ser', emoji: 'üëÆ' }, { name: 'Accountant', pron: 'a-c√°un-tant', emoji: 'üíº' }
            ];

            const numbersGrid = document.getElementById('numbers-grid');
            numbersGrid.innerHTML = numbersData.map(item => `
                <div class="vocab-card" onclick="speakPhrase('${item.word}', 'en-US')">
                    <h3>${item.num} <span class="speakable" onclick="event.stopPropagation(); speakPhrase('${item.word}', 'en-US')">üîä</span></h3>
                    <p class="phonetic">[${item.pron}]</p>
                    <p class="translation">${item.word}</p>
                </div>`).join('');
            
            const occupationsGrid = document.getElementById('occupations-grid');
            occupationsGrid.innerHTML = occupationsData.map(item => `
                 <div class="vocab-card" onclick="speakPhrase('${item.name}', 'en-US')">
                    <h3>${item.emoji} <span class="speakable" onclick="event.stopPropagation(); speakPhrase('${item.name}', 'en-US')">üîä</span></h3>
                    <p class="phonetic">[${item.pron}]</p>
                    <p class="translation">${item.name}</p>
                </div>`).join('');
            
            const steps = document.querySelectorAll('.lesson-step');
            steps.forEach((step, index) => { step.style.animationDelay = `${index * 0.08}s`; });
            
            if (lessonSections.length > 0) { updateActiveMenuItemDOM(lessonSections[0].id); }
            
            completionOverlayEl.addEventListener('click', (e) => {
                if (e.target.id === 'completionOverlay' || e.target.tagName === 'BUTTON') {
                    hideCompletionModal();
                }
            });
        });
    </script>
</body>
</html>